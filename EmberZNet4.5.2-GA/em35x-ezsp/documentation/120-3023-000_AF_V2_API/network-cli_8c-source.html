<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">

<title>Application Framework API Reference: network-cli.c Source File</title>

<LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">

</head><body>

<table border="0" cellspacing="0" cellpadding="0"  width=100%>

<tr>

<td><img src="emberLogoSmallWebsiteVer.gif"></td>

<td> <div class="qindex">

<a class="qindex" href="main.html">Home</a>&nbsp;

 | &nbsp;<a class="qindex" href="modules.html">Modules</a>&nbsp;

 | &nbsp;<a class="qindex" href="annotated.html">Data Structures</a>&nbsp;

 | &nbsp;<a class="qindex" href="files.html">File List</a>&nbsp;

 | &nbsp;<a class="qindex" href="dirs.html">Directories</a>&nbsp;

 | &nbsp;<a class="qindex" href="globals.html">Index</a></div>

</td>

</table>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_fecac40be0af2076ed38531225652d23.html">app</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a4fb87c2c2a3c9408923edef982c913e.html">framework</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_4ef1a1979ebdccd27c7586c656acac0e.html">cli</a>
  </div>
<div class="contents">
<h1>network-cli.c</h1><a href="network-cli_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// File: network-cli.c</span>
<a name="l00002"></a>00002 <span class="comment">//</span>
<a name="l00003"></a>00003 <span class="comment">// Copyright 2009 by Ember Corporation. All rights reserved.                *80*</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include "app/framework/util/common.h"</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include "app/framework/util/af-main.h"</span>  <span class="comment">// For APP_XXX_PRINT</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "app/util/serial/command-interpreter2.h"</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include "<a class="code" href="network-cli_8h.html">network-cli.h</a>"</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include "app/framework/util/network-find.h"</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="comment">// For zaNodeSecurityInit() and zaTrustCenterSecurityInit()</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include "app/framework/security/af-security.h"</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="keyword">static</span> <span class="keywordtype">void</span> networkJoinCommand(<span class="keywordtype">void</span>);
<a name="l00018"></a>00018 <span class="keyword">static</span> <span class="keywordtype">void</span> networkRejoinCommand(<span class="keywordtype">void</span>);
<a name="l00019"></a>00019 <span class="keyword">static</span> <span class="keywordtype">void</span> networkFormCommand(<span class="keywordtype">void</span>);
<a name="l00020"></a>00020 <span class="keyword">static</span> <span class="keywordtype">void</span> networkExtendedPanIdCommand(<span class="keywordtype">void</span>);
<a name="l00021"></a>00021 <span class="keyword">static</span> <span class="keywordtype">void</span> networkLeaveCommand(<span class="keywordtype">void</span>);
<a name="l00022"></a>00022 <span class="keyword">static</span> <span class="keywordtype">void</span> networkPermitJoinCommand(<span class="keywordtype">void</span>);
<a name="l00023"></a>00023 <span class="keyword">static</span> <span class="keywordtype">void</span> findJoinableNetworkCommand(<span class="keywordtype">void</span>);
<a name="l00024"></a>00024 <span class="keyword">static</span> <span class="keywordtype">void</span> findUnusedPanIdCommand(<span class="keywordtype">void</span>);
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#if defined(EMBER_AF_TC_SWAP_OUT_TEST)</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span>  <span class="keyword">static</span> <span class="keywordtype">void</span> networkInitCommand(<span class="keywordtype">void</span>);
<a name="l00028"></a>00028 <span class="preprocessor">#endif</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span>
<a name="l00077"></a><a class="code" href="group__cli.html#g70bf013b1ff53045ffbd8d0508445a7a">00077</a> <span class="preprocessor">#define EMBER_AF_DOXYGEN_CLI__NETWORK_COMMANDS</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>
<a name="l00080"></a>00080 <span class="comment">// form and join library ocmmands.</span>
<a name="l00081"></a>00081 <span class="keyword">static</span> EmberCommandEntry findCommands[] = {
<a name="l00082"></a>00082   {<span class="stringliteral">"joinable"</span>, findJoinableNetworkCommand, <span class="stringliteral">""</span> },
<a name="l00083"></a>00083   {<span class="stringliteral">"unused"</span>,   findUnusedPanIdCommand, <span class="stringliteral">""</span> },
<a name="l00084"></a>00084   { NULL },
<a name="l00085"></a>00085 };
<a name="l00086"></a><a class="code" href="network-cli_8h.html#e7cf6d63a19db73611a356876bd526d7">00086</a> EmberCommandEntry <a class="code" href="network-cli_8c.html#e7cf6d63a19db73611a356876bd526d7">networkCommands</a>[] = {
<a name="l00087"></a>00087   {<span class="stringliteral">"form"</span>, networkFormCommand, <span class="stringliteral">"usv"</span>},
<a name="l00088"></a>00088   {<span class="stringliteral">"join"</span>, networkJoinCommand, <span class="stringliteral">"usv"</span>},
<a name="l00089"></a>00089   {<span class="stringliteral">"rejoin"</span>, networkRejoinCommand, <span class="stringliteral">"uw"</span>},
<a name="l00090"></a>00090   {<span class="stringliteral">"leave"</span>, networkLeaveCommand, <span class="stringliteral">""</span>},
<a name="l00091"></a>00091   {<span class="stringliteral">"pjoin"</span>, networkPermitJoinCommand, <span class="stringliteral">"u"</span>},
<a name="l00092"></a>00092   {<span class="stringliteral">"extpanid"</span>, networkExtendedPanIdCommand, <span class="stringliteral">"b"</span>},
<a name="l00093"></a>00093   {<span class="stringliteral">"find"</span>, NULL, (PGM_P)findCommands},
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 #<span class="keywordflow">if</span> defined(EMBER_AF_TC_SWAP_OUT_TEST)
<a name="l00096"></a>00096   <span class="comment">// Do not document this command.</span>
<a name="l00097"></a>00097   {<span class="stringliteral">"init"</span>, networkInitCommand, <span class="stringliteral">""</span> },
<a name="l00098"></a>00098 <span class="preprocessor">#endif</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span>
<a name="l00100"></a>00100   { NULL }
<a name="l00101"></a>00101 };
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="network-cli_8h.html#d535f2de83fcb8adef83b4a9af1c7080">00105</a> <span class="keywordtype">void</span> <a class="code" href="network-cli_8c.html#d535f2de83fcb8adef83b4a9af1c7080">emberAfPrintChannelListFromMask</a>(int32u channelMask)
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107   int8u i;
<a name="l00108"></a>00108   <span class="keywordtype">boolean</span> firstPrint = TRUE;
<a name="l00109"></a>00109   channelMask &gt;&gt;= 11;           <span class="comment">// valid 802.15.4 channels start from 11</span>
<a name="l00110"></a>00110   <span class="keywordflow">for</span> (i = 11; i &lt;= 26; i++) {
<a name="l00111"></a>00111     <span class="keywordflow">if</span> (channelMask &amp; 0x01UL) {
<a name="l00112"></a>00112       <a class="code" href="debug-printing_8h.html#c7f24e99a4506f2138c1ce82b60a2d4e">emberAfAppPrint</a>(<span class="stringliteral">"%c %d"</span>, 
<a name="l00113"></a>00113                       (firstPrint
<a name="l00114"></a>00114                        ? <span class="charliteral">' '</span>
<a name="l00115"></a>00115                        : <span class="charliteral">','</span>),
<a name="l00116"></a>00116                       i);
<a name="l00117"></a>00117       firstPrint = FALSE;
<a name="l00118"></a>00118       <a class="code" href="debug-printing_8h.html#ea0772af28af33068bac0fad99a4feaf">emberAfAppFlush</a>();
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120     channelMask &gt;&gt;= 1;
<a name="l00121"></a>00121   }
<a name="l00122"></a>00122 }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="keyword">static</span> <span class="keywordtype">void</span> initNetworkParams(EmberNetworkParameters *networkParams)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126   MEMSET(networkParams, 0, <span class="keyword">sizeof</span>(EmberNetworkParameters));
<a name="l00127"></a>00127   MEMCOPY(networkParams-&gt;extendedPanId, 
<a name="l00128"></a>00128           emAfExtendedPanId,
<a name="l00129"></a>00129           EXTENDED_PAN_ID_SIZE);
<a name="l00130"></a>00130   networkParams-&gt;radioChannel = emberUnsignedCommandArgument(0);
<a name="l00131"></a>00131   networkParams-&gt;radioTxPower = emberUnsignedCommandArgument(1);
<a name="l00132"></a>00132   networkParams-&gt;panId = emberUnsignedCommandArgument(2);
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="comment">// network join &lt;channel&gt; &lt;power&gt; &lt;panid&gt;</span>
<a name="l00136"></a>00136 <span class="keyword">static</span> <span class="keywordtype">void</span> networkJoinCommand(<span class="keywordtype">void</span>)
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138   EmberStatus status;
<a name="l00139"></a>00139   EmberNetworkParameters networkParams;
<a name="l00140"></a>00140   initNetworkParams(&amp;networkParams);
<a name="l00141"></a>00141   status = emberAfJoinNetwork(&amp;networkParams);
<a name="l00142"></a>00142   <a class="code" href="debug-printing_8h.html#1fbed20f2364991963c40f135218f854">emberAfAppPrintln</a>(<span class="stringliteral">"%p 0x%x"</span>, <span class="stringliteral">"join"</span>, status);
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="comment">// network rejoin &lt;haveCurrentNetworkKey:1&gt; &lt;channelMask:4&gt;</span>
<a name="l00146"></a>00146 <span class="keyword">static</span> <span class="keywordtype">void</span> networkRejoinCommand(<span class="keywordtype">void</span>)
<a name="l00147"></a>00147 {
<a name="l00148"></a>00148   <span class="keywordtype">boolean</span> haveCurrentNetworkKey = (boolean)emberUnsignedCommandArgument(0);
<a name="l00149"></a>00149   int32u channelMask = emberUnsignedCommandArgument(1);
<a name="l00150"></a>00150   EmberStatus status = emberFindAndRejoinNetwork(haveCurrentNetworkKey,
<a name="l00151"></a>00151                                                  channelMask);
<a name="l00152"></a>00152   <a class="code" href="debug-printing_8h.html#1fbed20f2364991963c40f135218f854">emberAfAppPrintln</a>(<span class="stringliteral">"%p 0x%x"</span>, <span class="stringliteral">"rejoin"</span>, status);
<a name="l00153"></a>00153 }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 <span class="comment">// network form &lt;channel&gt; &lt;power&gt; &lt;panid&gt;</span>
<a name="l00156"></a>00156 <span class="keyword">static</span> <span class="keywordtype">void</span> networkFormCommand(<span class="keywordtype">void</span>)
<a name="l00157"></a>00157 {
<a name="l00158"></a>00158 <span class="preprocessor">#if (ZA_DEVICE_TYPE == ZA_COORDINATOR)</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>  EmberStatus status;
<a name="l00160"></a>00160   EmberNetworkParameters networkParams;
<a name="l00161"></a>00161   initNetworkParams(&amp;networkParams);
<a name="l00162"></a>00162   status = emberAfFormNetwork(&amp;networkParams);
<a name="l00163"></a>00163   <a class="code" href="debug-printing_8h.html#1fbed20f2364991963c40f135218f854">emberAfAppPrintln</a>(<span class="stringliteral">"%p 0x%x"</span>, <span class="stringliteral">"form"</span>, status);
<a name="l00164"></a>00164   <a class="code" href="debug-printing_8h.html#ea0772af28af33068bac0fad99a4feaf">emberAfAppFlush</a>();
<a name="l00165"></a>00165 <span class="preprocessor">#else  // (ZA_DEVICE_TYPE == ZA_COORDINATOR)</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>  <a class="code" href="debug-printing_8h.html#1fbed20f2364991963c40f135218f854">emberAfAppPrintln</a>(<span class="stringliteral">"only coordinators can form"</span>);
<a name="l00167"></a>00167 <span class="preprocessor">#endif // (ZA_DEVICE_TYPE == ZA_COORDINATOR)</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span>}
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 <span class="comment">// network extpanid &lt;8 BYTES&gt;</span>
<a name="l00171"></a>00171 <span class="keyword">static</span> <span class="keywordtype">void</span> networkExtendedPanIdCommand(<span class="keywordtype">void</span>)
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173   emberAfCopyBigEndianEui64Argument(0, emAfExtendedPanId);
<a name="l00174"></a>00174   <a class="code" href="debug-printing_8h.html#c7f24e99a4506f2138c1ce82b60a2d4e">emberAfAppPrint</a>(<span class="stringliteral">"ext. PAN ID: "</span>);
<a name="l00175"></a>00175   <a class="code" href="group__af.html#g18ddcce71fd7bb3cc1b750097f291676" title="prints eui64 stored in big endian format">emberAfPrintBigEndianEui64</a>(emAfExtendedPanId);
<a name="l00176"></a>00176   <a class="code" href="debug-printing_8h.html#1fbed20f2364991963c40f135218f854">emberAfAppPrintln</a>(<span class="stringliteral">""</span>);
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 <span class="comment">// network leave</span>
<a name="l00180"></a>00180 <span class="keyword">static</span> <span class="keywordtype">void</span> networkLeaveCommand(<span class="keywordtype">void</span>)
<a name="l00181"></a>00181 {
<a name="l00182"></a>00182   EmberStatus status;
<a name="l00183"></a>00183   status = emberLeaveNetwork();
<a name="l00184"></a>00184   <a class="code" href="debug-printing_8h.html#1fbed20f2364991963c40f135218f854">emberAfAppPrintln</a>(<span class="stringliteral">"%p 0x%x"</span>, <span class="stringliteral">"leave"</span>,  status);
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="comment">// network pjoin &lt;time&gt;</span>
<a name="l00188"></a>00188 <span class="keyword">static</span> <span class="keywordtype">void</span> networkPermitJoinCommand(<span class="keywordtype">void</span>)
<a name="l00189"></a>00189 {
<a name="l00190"></a>00190   int8u duration = (int8u)emberUnsignedCommandArgument(0);
<a name="l00191"></a>00191   emAfPermitJoin(duration);
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="preprocessor">#if defined (ZA_SECURITY_RANDOM_LINK_KEY) &amp;&amp; ZA_DEVICE_TYPE == ZA_COORDINATOR</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>  <span class="comment">// Random link keys means that joining nodes don't have a preconfigured key</span>
<a name="l00195"></a>00195   <span class="comment">// so we must send the NWK key in the clear.</span>
<a name="l00196"></a>00196   <span class="comment">// This will automatically timeout in 30 seconds and stop sending the NWK</span>
<a name="l00197"></a>00197   <span class="comment">// key in the clear.</span>
<a name="l00198"></a>00198   zaTrustCenterSetJoinPolicy(EMBER_SEND_KEY_IN_THE_CLEAR);
<a name="l00199"></a>00199 <span class="preprocessor">#endif</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>}
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="keyword">static</span> <span class="keywordtype">void</span> findJoinableNetworkCommand(<span class="keywordtype">void</span>)
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204   emberAfStartSearchForJoinableNetwork();
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="keyword">static</span> <span class="keywordtype">void</span> findUnusedPanIdCommand(<span class="keywordtype">void</span>)
<a name="l00208"></a>00208 {
<a name="l00209"></a>00209   emberAfFindUnusedPanIdAndForm();
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 <span class="preprocessor">#if defined(EMBER_AF_TC_SWAP_OUT_TEST)</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> networkInitCommand(<span class="keywordtype">void</span>)
<a name="l00214"></a>00214 {
<a name="l00215"></a>00215   emAfNetworkInitReturnCodeStatus = emberNetworkInit();
<a name="l00216"></a>00216   <a class="code" href="debug-printing_8h.html#1fbed20f2364991963c40f135218f854">emberAfAppPrintln</a>(<span class="stringliteral">"Network Init returned: 0x%X"</span>, 
<a name="l00217"></a>00217                     emAfNetworkInitReturnCodeStatus);
<a name="l00218"></a>00218   emAfNetworkInit();
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 <span class="preprocessor">#endif</span>
</pre></div></div>
<hr size="1">

<table border="0" cellspacing="0" cellpadding="0" width=100%>

<tr>

<td><address><small>

Application Framework API Reference. <br>

Application Framework V2.

</small></address>

</td>

<td align="right">

<address><small>

Copyright &copy; 2006-2010 by Ember Corporation. All rights reserved.<br>

Generated Tue Oct 12 10:24:37 2010 with <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.5.8.

</small></address>

</td>

</tr>

</table>

</body>

</html>
